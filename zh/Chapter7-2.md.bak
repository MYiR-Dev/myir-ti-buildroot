### 7.2 WIFI 模块

本章讲述USB WIFI和SIDO WIFI在开发板的上的环境搭建和测试过程。

**硬件环境：**

* MYD-AM335X系列开发板一块

* MY-WF003U 模块、MY-WF004S 模块

* USB转TTL调试串口一根，连接MYD-AM335X系列开发板 Debug串口和PC, PC端波特率设置115200-8-n-1

| 接口 | MYD-AM335X | MYD-AM335X-Y | MYD-AM335X-J |
| :--- | :--- | :--- | :--- |
| Debug串口 | J12 UART0 | J10  Debug UART | J3 USB\_UART |
| USB接口 | J3 J4 | J19 USB\_HOST | J27 USB\_HOST |
| SDIO接口 | J17 TF\_CARD | J12 | J19 Micro\_SD |

**软件环境：**

* Linux Kernel 4.1.18

* wpa\_supplicant 应用程序

* hostapd 应用程序

* iptables 应用程序

> **注意：包含MEASY-HMI的系统中connman与network manager冲突，如要测试WIFI,需先禁用connman。可以将/etc/init.d/S45connman重命名为/etc/init.d/K45connman之后重启系统**


| 开发板 | 设备树 |
| :--- | :--- |
| MYD-AM335X | myd\_c335x.dtb |
| MYD-AM335X-Y | myd\_y335x.dtb |
| MYD-AM335X-J | myd\_j335x.dtb |

**测试过程：**

将MY-WF003U 模块插入开发板USB接口或者MY-WF004S 模块插入开发板TF卡接口，使用命令`ifconfig -a`即可看到模块已加载驱动并生成了WLAN设备。

```
# ifconfig -a


eth0      Link encap:Ethernet  HWaddr 68:9E:19:BC:1C:84  
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
          Interrupt:240 

eth1      Link encap:Ethernet  HWaddr 68:9E:19:BC:1C:86  
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

wlan0     Link encap:Ethernet  HWaddr 00:1D:43:A0:04:11  
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
```

**WIFI STA模式**

1.修改_/etc/wap\_supplicant.conf_配置文件中ssid和psk的值，ssid为测试环境中的wifi ap名称，psk为测试环境中wifi ap的密码。

```
# cat /etc/wpa_supplicant.conf 
ctrl_interface=/var/run/wpa_supplicant
ap_scan=1
p2p_disabled=1

network={  
 ssid="MYIR_TECH"
 scan_ssid=1
 proto=WPA RSN
 pairwise=CCMP TKIP NONE
 key_mgmt=WPA-EAP WPA-PSK IEEE8021X NONE
 group=TKIP CCMP
 psk="myir2016" 
 priority=10
}
```

2.连接wifi ap。

\#`wpa_supplicant -i wlan0 -c /etc/wpa_supplicant.conf -B`

3.获取IP地址及DNS。

```
#udhcpc -b -i wlan0
udhcpc: started, v1.25.1
udhcpc: sending discover
udhcpc: sending select for 192.168.30.115
udhcpc: lease of 192.168.30.115 obtained, lease time 3600
deleting routers
adding dns 223.5.5.5
adding dns 201.104.111.114
```

4.ping测试。

```
# ping www.baidu.com
PING www.baidu.com (61.135.169.125): 56 data bytes
64 bytes from 61.135.169.125: seq=0 ttl=56 time=29.253 ms
64 bytes from 61.135.169.125: seq=1 ttl=56 time=32.218 ms
64 bytes from 61.135.169.125: seq=2 ttl=56 time=24.717 ms
64 bytes from 61.135.169.125: seq=4 ttl=56 time=141.210 ms
64 bytes from 61.135.169.125: seq=5 ttl=56 time=64.064 ms
64 bytes from 61.135.169.125: seq=11 ttl=56 time=133.112 ms
```

**WIFI SoftAP模式**

1.修改_/etc/hostapd.conf_配置文件中ssid和wpa\_passphrase的值，ssid为wifi模块生成的ap热点的名称，wpa\_passphrase为ap热点的密码。

```
# cat /etc/hostapd.conf 
interface=wlan0
ssid=myirAP
hw_mode=g
channel=6
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=123456789
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
```

2.根据需求修改/etc/dhcp/dhcpd.conf 配置文件中所内容，这个配置文件主要是为连上wifi ap设备提供DHCP服务。

```
# cat /etc/dhcp/dhcpd.conf 
ddns-update-style interim;
ignore client-updates;

subnet 192.168.43.0 netmask 255.255.255.0{
range 192.168.43.100 192.168.43.150;
default-lease-time 86400;
max-lease-time 86400;
option routers 192.168.43.1;
option broadcast-address 192.168.43.255;
option subnet-mask 255.255.255.0;
option domain-name "redpinesignals.com";
option domain-name-servers 114.114.114.114;
host VAP_0.redpinesignals.com{
        hardware ethernet 00:23:a7:3a:11:d1;
        fixed-address 192.168.43.1;
        }
}
```

3.创建ap热点。

```
# hostapd /etc/hostapd.conf -B
Configuration file: /etc/hostapd.conf
Using interface wlan0 with hwaddr 00:1d:43:a0:04:11 and ssid "myirAP"
random: Only 15/20 bytes of strong random data available from /dev/random
random: Not enough entropy pool available for secure operations
WPA: Not enough entropy in random pool for secure operations - update keys later when the 
first station connects
wlan0: interface state UNINITIALIZED->ENABLED
wlan0: AP-ENABLED
```

4.配置ap热点的ip地址和子网掩码，这个IP地址需要根据/etc/dhcp/dhcpd.conf中routers的值来进行设置。

```
# ifconfig wlan0 192.168.43.1 netmask 255.255.255.0 up
```

5.启动wlan0的DHCP服务。

```
# dhcpd wlan0
Internet Systems Consortium DHCP Server 4.3.5
Copyright 2004-2016 Internet Systems Consortium.
All rights reserved.
For info, please visit https://www.isc.org/software/dhcp/
WARNING: Host declarations are global.  They are not limited to the scope you declared 
them in.
Config file: /etc/dhcp/dhcpd.conf
Database file: /var/lib/dhcp/dhcpd.leases
PID file: /var/run/dhcpd.pid
Wrote 0 deleted host decls to leases file.
Wrote 0 new dynamic host decls to leases file.
Wrote 0 leases to leases file.
Listening on LPF/wlan0/00:1d:43:a0:04:11/192.168.43.0/24
Sending on   LPF/wlan0/00:1d:43:a0:04:11/192.168.43.0/24
Sending on   Socket/fallback/fallback-net
```

完成上面五个步骤已经可以使用其他WIFI STA模式的设备来连接所创建的AP热点了，不过只能进行局域网通信，如需进行外网通信还要完成下面步骤。

1.将eth0接入互联网络，并获取IP地址。

```
# udhcpc eth0
udhcpc: started, v1.25.1
udhcpc: sending discover
udhcpc: sending select for 192.168.30.160
udhcpc: lease of 192.168.30.160 obtained, lease time 3600
deleting routers
adding dns 223.5.5.5
adding dns 201.104.111.114
```

2.打开IP报文转发。

```
echo 1 > /proc/sys/net/ipv4/ip_forward
```

3.配置eth0为所有报文的出口。

```
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

执行完上述3个步骤，WIFI设备就可通过这个AP热点访问互联网了。

